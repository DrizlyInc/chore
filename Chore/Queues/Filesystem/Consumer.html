<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Chore::Queues::Filesystem::Consumer
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../../';
  framesUrl = "../../../frames.html#!Chore/Queues/Filesystem/Consumer.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Queues.html" title="Chore::Queues (module)">Queues</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Filesystem.html" title="Chore::Queues::Filesystem (module)">Filesystem</a></span></span>
     &raquo; 
    <span class="title">Consumer</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Chore::Queues::Filesystem::Consumer
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></li>
          
            <li class="next">Chore::Queues::Filesystem::Consumer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/chore/queues/filesystem/consumer.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This is the consuming side of the file system queue. This class consumes
jobs created by FilesystemPublisher#publish.  The root of the file system
queue is configured in Chore.config.fs_queue_root. In there a directory
will be created for each queue name. Each queue directory contains a
directory called "new" and one called "inprogress".
FilesystemPublisher#publish creates new job files in the "new" directory.
This consumer polls that directory every 5 seconds for new jobs which are
moved to "inprogress".</p>

<p>Once complete job files are deleted. If rejected they are moved back into
new and will be processed again.  This may not be the desired behavior long
term and we may want to add configuration to this class to allow more
creating failure handling and retrying.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="FILE_QUEUE_MUTEXES-constant" class="">FILE_QUEUE_MUTEXES =
          
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span><span class='rbrace'>}</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#IN_PROGRESS_DIR-constant" title="Chore::FilesystemQueue::IN_PROGRESS_DIR (constant)">FilesystemQueue::IN_PROGRESS_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#NEW_JOB_DIR-constant" title="Chore::FilesystemQueue::NEW_JOB_DIR (constant)">FilesystemQueue::NEW_JOB_DIR</a></span></p>


  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#queue_timeout-instance_method" title="#queue_timeout (instance method)">- (Object) <strong>queue_timeout</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The amount of time units of work can run before the queue considers them
timed out.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Consumer.html#queue_name-instance_method" title="Chore::Consumer#queue_name (method)">#queue_name</a></span></p>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#complete-instance_method" title="#complete (instance method)">- (Object) <strong>complete</strong>(id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#consume-instance_method" title="#consume (instance method)">- (Object) <strong>consume</strong>(&amp;handler) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Consumer) <strong>initialize</strong>(queue_name, opts = {}) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of Consumer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reject-instance_method" title="#reject (instance method)">- (Object) <strong>reject</strong>(id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#in_progress_dir-instance_method" title="Chore::FilesystemQueue#in_progress_dir (method)">#in_progress_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#new_dir-instance_method" title="Chore::FilesystemQueue#new_dir (method)">#new_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#queue_dir-instance_method" title="Chore::FilesystemQueue#queue_dir (method)">#queue_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#root_dir-instance_method" title="Chore::FilesystemQueue#root_dir (method)">#root_dir</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Consumer.html#reset_connection%21-class_method" title="Chore::Consumer.reset_connection! (method)">reset_connection!</a></span>, <span class='object_link'><a href="../../Consumer.html#running%3F-instance_method" title="Chore::Consumer#running? (method)">#running?</a></span>, <span class='object_link'><a href="../../Consumer.html#stop-instance_method" title="Chore::Consumer#stop (method)">#stop</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Chore::Queues::Filesystem::Consumer (class)">Consumer</a></span></tt>) <strong>initialize</strong>(queue_name, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of Consumer</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


30
31
32
33
34
35
36
37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 30</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>

  <span class='comment'># Even though putting these Mutexes in this hash is, by itself, not particularly threadsafe
</span>  <span class='comment'># as long as some Mutex ends up in the queue after all consumers are created we're good
</span>  <span class='comment'># as they are pulled from the queue and synchronized for file operations below
</span>  <span class='const'>FILE_QUEUE_MUTEXES</span><span class='lbracket'>[</span><span class='ivar'>@queue_name</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='ivar'>@in_progress_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span>
  <span class='ivar'>@new_dir</span> <span class='op'>=</span> <span class='id identifier rubyid_new_dir'>new_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span>
  <span class='ivar'>@queue_timeout</span> <span class='op'>=</span> <span class='const'>Chore</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_default_queue_timeout'>default_queue_timeout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="queue_timeout-instance_method">
  
    - (<tt>Object</tt>) <strong>queue_timeout</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The amount of time units of work can run before the queue considers them
timed out.  For filesystem queues, this is the global default.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


28
29
30</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 28</span>

<span class='kw'>def</span> <span class='id identifier rubyid_queue_timeout'>queue_timeout</span>
  <span class='ivar'>@queue_timeout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="complete-instance_method">
  
    - (<tt>Object</tt>) <strong>complete</strong>(id) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


62
63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 62</span>

<span class='kw'>def</span> <span class='id identifier rubyid_complete'>complete</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='const'>Chore</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Completing (deleting): </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_rm'>rm</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='ivar'>@in_progress_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="consume-instance_method">
  
    - (<tt>Object</tt>) <strong>consume</strong>(&amp;handler) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


43
44
45
46
47
48
49
50
51
52
53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 43</span>

<span class='kw'>def</span> <span class='id identifier rubyid_consume'>consume</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
  <span class='const'>Chore</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Starting consuming file system queue </span><span class='embexpr_beg'>#{</span><span class='ivar'>@queue_name</span><span class='rbrace'>}</span><span class='tstring_content'> in </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_queue_dir'>queue_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>while</span> <span class='id identifier rubyid_running?'>running?</span>
    <span class='kw'>begin</span>
      <span class='comment'>#TODO move expired job files to new directory?
</span>      <span class='id identifier rubyid_handle_jobs'>handle_jobs</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Chore</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='rbrace'>}</span><span class='tstring_content'>#consume: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='rbrace'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span> <span class='op'>*</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>5</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reject-instance_method">
  
    - (<tt>Object</tt>) <strong>reject</strong>(id) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 57</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reject'>reject</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='const'>Chore</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Rejecting: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_make_new_again'>make_new_again</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Sep 26 10:20:09 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-1.9.3).
</div>

  </body>
</html>