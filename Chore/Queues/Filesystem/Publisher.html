<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Chore::Queues::Filesystem::Publisher
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../../';
  framesUrl = "../../../frames.html#!Chore/Queues/Filesystem/Publisher.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Queues.html" title="Chore::Queues (module)">Queues</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Filesystem.html" title="Chore::Queues::Filesystem (module)">Filesystem</a></span></span>
     &raquo; 
    <span class="title">Publisher</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Chore::Queues::Filesystem::Publisher
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></li>
          
            <li class="next">Chore::Queues::Filesystem::Publisher</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/chore/queues/filesystem/publisher.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Publisher for writing jobs to the local filesystem. Useful for testing in
offline environments or when queuing implementations are irrelevent to the
task at hand, such as local development of new jobs.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="FILE_MUTEX-constant" class="">FILE_MUTEX =
          <div class="docstring">
  <div class="discussion">
    
<p>Mutex for holding a lock over the files for this queue while they are in
process</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#IN_PROGRESS_DIR-constant" title="Chore::FilesystemQueue::IN_PROGRESS_DIR (constant)">FilesystemQueue::IN_PROGRESS_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#NEW_JOB_DIR-constant" title="Chore::FilesystemQueue::NEW_JOB_DIR (constant)">FilesystemQueue::NEW_JOB_DIR</a></span></p>

  
  
  <h3 class="inherited">Constants inherited
     from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#DEFAULT_OPTIONS-constant" title="Chore::Publisher::DEFAULT_OPTIONS (constant)">Publisher::DEFAULT_OPTIONS</a></span></p>




  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#options-instance_method" title="Chore::Publisher#options (method)">#options</a></span></p>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#filename-instance_method" title="#filename (instance method)">- (Object) <strong>filename</strong>(queue_name, job_name) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>create a unique filename for a job in a queue based on queue name, job name
and date.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish-instance_method" title="#publish (instance method)">- (Object) <strong>publish</strong>(queue_name, job) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>use of mutex and file locking should make this both threadsafe and safe for
multiple processes to use the same queue directory simultaneously.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#in_progress_dir-instance_method" title="Chore::FilesystemQueue#in_progress_dir (method)">#in_progress_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#new_dir-instance_method" title="Chore::FilesystemQueue#new_dir (method)">#new_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#queue_dir-instance_method" title="Chore::FilesystemQueue#queue_dir (method)">#queue_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#root_dir-instance_method" title="Chore::FilesystemQueue#root_dir (method)">#root_dir</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#initialize-instance_method" title="Chore::Publisher#initialize (method)">#initialize</a></span>, <span class='object_link'><a href="../../Publisher.html#publish-class_method" title="Chore::Publisher.publish (method)">publish</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <p class="notice">This class inherits a constructor from <span class='object_link'><a href="../../Publisher.html#initialize-instance_method" title="Chore::Publisher#initialize (method)">Chore::Publisher</a></span></p>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="filename-instance_method">
  
    - (<tt>Object</tt>) <strong>filename</strong>(queue_name, job_name) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>create a unique filename for a job in a queue based on queue name, job name
and date</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/publisher.rb', line 37</span>

<span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_job_name'>job_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y%m%d-%H%M%S-%6N</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_previous_attempts'>previous_attempts</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_new_dir'>new_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rbrace'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_job_name'>job_name</span><span class='rbrace'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_now'>now</span><span class='rbrace'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='rbrace'>}</span><span class='tstring_content'>.job</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish-instance_method">
  
    - (<tt>Object</tt>) <strong>publish</strong>(queue_name, job) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>use of mutex and file locking should make this both threadsafe and safe for
multiple processes to use the same queue directory simultaneously.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/publisher.rb', line 18</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
  <span class='const'>FILE_MUTEX</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>while</span> <span class='kw'>true</span>
      <span class='comment'># keep trying to get a file with nothing in it meaning we just created it
</span>      <span class='comment'># as opposed to us getting someone else's file that hasn't been processed yet.
</span>      <span class='id identifier rubyid_f'>f</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:class</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>w</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_EX</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_NB</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>0</span>
        <span class='kw'>begin</span>
          <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_json'>to_json</span><span class='rparen'>)</span>
        <span class='kw'>ensure</span>
          <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_UN</span><span class='rparen'>)</span>
          <span class='kw'>break</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Sep 26 10:20:09 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-1.9.3).
</div>

  </body>
</html>