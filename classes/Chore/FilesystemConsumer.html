<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Chore::FilesystemConsumer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            Chore::FilesystemConsumer 
            
                <span class="parent">&lt; 
                    
                    <a href="Consumer.html">Chore::Consumer</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/chore/consumers/filesystem_consumer_rb.html">lib/chore/consumers/filesystem_consumer.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>This is the consuming side of the file system queue. This class consumes
jobs created by <a
href="FilesystemPublisher.html#method-i-publish">Chore::FilesystemPublisher#publish</a>.
The root of the file system queue is configured in <a
href="../Chore.html#method-c-config">Chore.config</a>.fs_queue_root. In
there a directory will be created for each queue name. Each queue directory
contains a directory called “new” and one called “inprogress”. <a
href="FilesystemPublisher.html#method-i-publish">Chore::FilesystemPublisher#publish</a>
creates new job files in the “new” directory. This consumer polls that
directory every 5 seconds for new jobs which are moved to “inprogress”.</p>

<p>Once complete job files are deleted. If rejected they are moved back into
new and will be processed again.  This may not be the desired behavior long
term and we may want to add configuration to this class to allow more
creating failure handling and retrying.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-complete">complete</a>,
              </li>
            
              
              <li>
                <a href="#method-i-consume">consume</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-reject">reject</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="FilesystemQueue.html">
              Chore::FilesystemQueue
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">FILE_QUEUE_MUTEXES</td>
            <td>=</td>
            <td class="attr-value">{}</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <b>new</b>(queue_name, opts={})
            
            <a href="../../classes/Chore/FilesystemConsumer.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/chore/consumers/filesystem_consumer.rb, line 22</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span>(<span class="ruby-identifier">queue_name</span>, <span class="ruby-identifier">opts</span>={})
  <span class="ruby-keyword">super</span>(<span class="ruby-identifier">queue_name</span>, <span class="ruby-identifier">opts</span>)

  <span class="ruby-comment"># Even though putting these Mutexes in this hash is, by itself, not particularly threadsafe</span>
  <span class="ruby-comment"># as long as some Mutex ends up in the queue after all consumers are created we're good</span>
  <span class="ruby-comment"># as they are pulled from the queue and synchronized for file operations below</span>
  <span class="ruby-constant">FILE_QUEUE_MUTEXES</span>[<span class="ruby-ivar">@queue_name</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>

  <span class="ruby-ivar">@in_progress_dir</span> = <span class="ruby-identifier">in_progress_dir</span>(<span class="ruby-identifier">queue_name</span>)
  <span class="ruby-ivar">@new_dir</span> = <span class="ruby-identifier">new_dir</span>(<span class="ruby-identifier">queue_name</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-complete">
            
              <b>complete</b>(id)
            
            <a href="../../classes/Chore/FilesystemConsumer.html#method-i-complete" name="method-i-complete" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-complete_source')" id="l_method-i-complete_source">show</a>
                
              </p>
              <div id="method-i-complete_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/chore/consumers/filesystem_consumer.rb, line 53</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">complete</span>(<span class="ruby-identifier">id</span>)
  <span class="ruby-constant">Chore</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Completing (deleting): #{id}&quot;</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@in_progress_dir</span>, <span class="ruby-identifier">id</span>))
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-consume">
            
              <b>consume</b>(&amp;handler)
            
            <a href="../../classes/Chore/FilesystemConsumer.html#method-i-consume" name="method-i-consume" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-consume_source')" id="l_method-i-consume_source">show</a>
                
              </p>
              <div id="method-i-consume_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/chore/consumers/filesystem_consumer.rb, line 34</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">consume</span>(&amp;<span class="ruby-identifier">handler</span>)
  <span class="ruby-constant">Chore</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Starting consuming file system queue #{@queue_name} in #{queue_dir(queue_name)}&quot;</span>
  <span class="ruby-keyword">while</span> <span class="ruby-identifier">running?</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-comment">#TODO move expired job files to new directory?</span>
      <span class="ruby-identifier">handle_jobs</span>(&amp;<span class="ruby-identifier">handler</span>)
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-constant">Chore</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span> { <span class="ruby-node">&quot;#{self.class}#consume: #{e} #{e.backtrace * &quot;\n&quot;}&quot;</span> }
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">sleep</span> <span class="ruby-number">5</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-reject">
            
              <b>reject</b>(id)
            
            <a href="../../classes/Chore/FilesystemConsumer.html#method-i-reject" name="method-i-reject" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-reject_source')" id="l_method-i-reject_source">show</a>
                
              </p>
              <div id="method-i-reject_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/chore/consumers/filesystem_consumer.rb, line 48</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">reject</span>(<span class="ruby-identifier">id</span>)
  <span class="ruby-constant">Chore</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Rejecting: #{id}&quot;</span>
  <span class="ruby-identifier">make_new_again</span>(<span class="ruby-identifier">id</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    